#!/usr/bin/env perl

use strict;
use warnings;
use Search::ESsearcher;
use Getopt::Long qw(:config pass_through);

# set all the templates the servers use to to fault
my $search;
my $options;
my $output;
my $elastic;
my $module;
my $invert;
my $print_search;
GetOptions(
		   's=s' => \$search,
		   'g=s' => \$options,
		   'o=s' => \$output,
		   'e=s' => \$elastic,
		   'S' => \$print_search,
		   'm=s' => \$module,
		   'i' => \$invert,
		   );

# Use module as the base to use allowing
# the other settings to override it if defined.
if (defined( $module )){
	if (!defined( $options )){
		$options=$module;
	}
	if (!defined( $output )){
		$output=$module;
	}
	if (!defined( $search )){
		$search=$module;
	}
}

my $ess = Search::ESsearcher->new();

# reels in the options
$ess->options_set( $options );
$ess->load_options;
$ess->get_options;

# reels in the search template
$ess->search_set( $search );
$ess->load_search;
my $filled_in=$ess->search_fill_in;
if ( $print_search ){
	print $filled_in;
	exit 255;
}

# reels in the elastic config
$ess->elastic_set( $elastic );
$ess->load_elastic;

#runs the search
my $results=$ess->search_run;

# processes the results
$ess->load_output;
my @formatted=$ess->results_process( $results );
#invert if requested
if ($invert){
	@formatted=reverse(@formatted);
}
print join("\n", @formatted)."\n";

#use Data::Dumper;
#print Dumper( $results );

